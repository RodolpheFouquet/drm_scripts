# test_ezdrm.py
from ezdrm import EZDrm, PLAYREADY_SYSID, WIDEVINE_SYSID
import requests_mock
import xmltodict

def test_init():
    d = EZDrm("https://test", "kid", "content", "user", "passwd")
    assert d.url == "https://test"
    assert d.kid == "kid"
    assert d.contentId == "content"
    assert d.user == "user"
    assert d.password == "passwd"


def test_fetch():
    with requests_mock.Mocker() as m:
        m.get(
            "https://test?c=content&k=kid&u=user&p=passwd",
            text=open("tests/data.xml").read(),
        )
        d = EZDrm("https://test", "kid", "content", "user", "passwd")
        d.fetch()
        expected = xmltodict.parse(open("tests/data.xml").read())
        assert d.content_dict == expected


def test_parse():
    d = EZDrm("https://test", "kid", "content", "user", "passwd")
    d.content_dict = xmltodict.parse(open("tests/data.xml").read())
    d.parseKeys()

    assert d.version == "2.3"
    assert d.contentId == "Mp4box-test01"
    assert d.explicitIV == "B44F9E302FB649B4990F01F3FC4BFE2D"
    assert d.secretKey == "7103438F487FB7AB0BFAF18FF19677F8"
    assert (
        base64.b64decode(d.psshList[WIDEVINE_SYSID].encode("ascii")).hex().upper()
        == "0000003F7073736800000000EDEF8BA979D64ACEA3C827DCD51D21ED0000001F1210B44F9E302FB649B4990F01F3FC4BFE2D1A05657A64726D48E3DC959B06"
    )
    assert (
        base64.b64decode(d.psshList[PLAYREADY_SYSID].encode("ascii")).hex().upper()
        == "000002B870737368000000009A04F07998404286AB92E65BE0885F950000029898020000010001008E023C00570052004D00480045004100440045005200200078006D006C006E0073003D00220068007400740070003A002F002F0073006300680065006D00610073002E006D006900630072006F0073006F00660074002E0063006F006D002F00440052004D002F0032003000300037002F00300033002F0050006C00610079005200650061006400790048006500610064006500720022002000760065007200730069006F006E003D00220034002E0030002E0030002E00300022003E003C0044004100540041003E003C00500052004F00540045004300540049004E0046004F003E003C004B00450059004C0045004E003E00310036003C002F004B00450059004C0045004E003E003C0041004C004700490044003E004100450053004300540052003C002F0041004C004700490044003E003C002F00500052004F00540045004300540049004E0046004F003E003C004B00490044003E004D004A003500500074004C0059007600740045006D005A004400770048007A002F00450076002B004C0051003D003D003C002F004B00490044003E003C0043004800450043004B00530055004D003E00620042006600490067006700380068005A00630063003D003C002F0043004800450043004B00530055004D003E003C004C0041005F00550052004C003E00680074007400700073003A002F002F0070006C0061007900720065006100640079002E0065007A00640072006D002E0063006F006D002F00630065006E00630079002F0070007200650061007500740068002E0061007300700078003F00700058003D004500300031003800330046003C002F004C0041005F00550052004C003E003C002F0044004100540041003E003C002F00570052004D004800450041004400450052003E00"
    )
    assert d.widevine_pssh == d.psshList[WIDEVINE_SYSID]
    assert d.playready_pssh == d.psshList[PLAYREADY_SYSID]
